/*******************************************************************************
 * Copyright 2012 assoba.fr
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *   http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 ******************************************************************************/
package fr.assoba.open.perf;


public class Histogram {

	// Generated with LogNormal function, see Tests
	private static long[] micros = new long[] { 0, 117, 184, 243, 297, 349,
			400, 449, 498, 545, 593, 639, 686, 732, 779, 825, 871, 917, 963,
			1009, 1055, 1101, 1147, 1193, 1239, 1286, 1332, 1379, 1426, 1473,
			1520, 1567, 1615, 1662, 1710, 1758, 1806, 1854, 1903, 1952, 2000,
			2050, 2099, 2148, 2198, 2248, 2298, 2349, 2399, 2450, 2501, 2553,
			2604, 2656, 2708, 2760, 2813, 2865, 2918, 2972, 3025, 3079, 3133,
			3187, 3241, 3296, 3351, 3406, 3462, 3517, 3573, 3630, 3686, 3743,
			3800, 3857, 3915, 3973, 4031, 4089, 4148, 4207, 4266, 4326, 4386,
			4446, 4506, 4567, 4628, 4689, 4751, 4812, 4875, 4937, 5000, 5063,
			5126, 5189, 5253, 5317, 5382, 5447, 5512, 5577, 5643, 5709, 5775,
			5842, 5909, 5976, 6043, 6111, 6180, 6248, 6317, 6386, 6455, 6525,
			6595, 6666, 6737, 6808, 6879, 6951, 7023, 7095, 7168, 7241, 7315,
			7388, 7462, 7537, 7612, 7687, 7762, 7838, 7914, 7991, 8068, 8145,
			8222, 8300, 8379, 8457, 8536, 8616, 8695, 8776, 8856, 8937, 9018,
			9100, 9182, 9264, 9347, 9430, 9513, 9597, 9681, 9766, 9851, 9936,
			10022, 10108, 10194, 10281, 10369, 10456, 10544, 10633, 10722,
			10811, 10901, 10991, 11081, 11172, 11264, 11356, 11448, 11540,
			11633, 11727, 11821, 11915, 12009, 12105, 12200, 12296, 12392,
			12489, 12587, 12684, 12782, 12881, 12980, 13079, 13179, 13280,
			13381, 13482, 13584, 13686, 13788, 13891, 13995, 14099, 14203,
			14308, 14414, 14520, 14626, 14733, 14840, 14948, 15056, 15165,
			15274, 15384, 15494, 15605, 15716, 15828, 15940, 16053, 16166,
			16280, 16394, 16509, 16624, 16740, 16856, 16973, 17090, 17208,
			17326, 17445, 17564, 17684, 17805, 17926, 18047, 18169, 18292,
			18415, 18539, 18663, 18788, 18914, 19039, 19166, 19293, 19421,
			19549, 19678, 19807, 19937, 20068, 20199, 20330, 20463, 20595,
			20729, 20863, 20998, 21133, 21269, 21405, 21542, 21680, 21818,
			21957, 22096, 22237, 22377, 22519, 22661, 22803, 22947, 23091,
			23235, 23381, 23526, 23673, 23820, 23968, 24116, 24266, 24415,
			24566, 24717, 24869, 25022, 25175, 25329, 25483, 25639, 25795,
			25951, 26109, 26267, 26425, 26585, 26745, 26906, 27068, 27230,
			27393, 27557, 27722, 27887, 28053, 28220, 28388, 28556, 28725,
			28895, 29066, 29237, 29409, 29582, 29756, 29930, 30106, 30282,
			30458, 30636, 30815, 30994, 31174, 31355, 31537, 31719, 31903,
			32087, 32272, 32458, 32645, 32832, 33021, 33210, 33400, 33591,
			33783, 33976, 34169, 34364, 34559, 34756, 34953, 35151, 35350,
			35550, 35751, 35952, 36155, 36359, 36563, 36769, 36975, 37182,
			37391, 37600, 37810, 38021, 38234, 38447, 38661, 38876, 39092,
			39309, 39527, 39746, 39966, 40188, 40410, 40633, 40857, 41082,
			41309, 41536, 41764, 41994, 42225, 42456, 42689, 42923, 43157,
			43393, 43630, 43869, 44108, 44348, 44590, 44832, 45076, 45321,
			45567, 45814, 46063, 46312, 46563, 46815, 47068, 47322, 47578,
			47835, 48092, 48352, 48612, 48874, 49136, 49400, 49666, 49932,
			50200, 50469, 50740, 51011, 51284, 51559, 51834, 52111, 52389,
			52669, 52950, 53232, 53515, 53800, 54087, 54374, 54663, 54954,
			55246, 55539, 55834, 56130, 56427, 56726, 57027, 57328, 57632,
			57937, 58243, 58551, 58860, 59171, 59483, 59797, 60112, 60429,
			60747, 61067, 61389, 61712, 62037, 62363, 62691, 63020, 63351,
			63684, 64019, 64355, 64692, 65032, 65373, 65715, 66060, 66406,
			66754, 67104, 67455, 67808, 68163, 68520, 68878, 69238, 69600,
			69964, 70330, 70697, 71066, 71438, 71811, 72186, 72563, 72941,
			73322, 73705, 74089, 74476, 74864, 75254, 75647, 76041, 76438,
			76836, 77237, 77639, 78044, 78450, 78859, 79270, 79683, 80098,
			80515, 80935, 81356, 81780, 82206, 82634, 83064, 83497, 83932,
			84369, 84808, 85250, 85694, 86141, 86589, 87040, 87494, 87949,
			88408, 88868, 89331, 89797, 90265, 90735, 91208, 91683, 92161,
			92642, 93125, 93611, 94099, 94590, 95083, 95579, 96078, 96580,
			97084, 97591, 98100, 98613, 99128, 99646, 100167, 100690, 101217,
			101746, 102278, 102814, 103352, 103893, 104437, 104984, 105534,
			106087, 106643, 107202, 107764, 108329, 108898, 109469, 110044,
			110622, 111203, 111788, 112376, 112967, 113561, 114159, 114760,
			115364, 115972, 116584, 117198, 117817, 118438, 119064, 119693,
			120325, 120961, 121601, 122244, 122891, 123542, 124197, 124855,
			125517, 126183, 126853, 127526, 128204, 128886, 129571, 130261,
			130954, 131652, 132353, 133059, 133769, 134483, 135202, 135924,
			136651, 137383, 138118, 138858, 139602, 140351, 141105, 141862,
			142625, 143392, 144163, 144940, 145720, 146506, 147296, 148092,
			148892, 149697, 150507, 151321, 152141, 152966, 153796, 154631,
			155471, 156317, 157167, 158023, 158884, 159751, 160623, 161500,
			162383, 163272, 164166, 165066, 165971, 166882, 167799, 168722,
			169651, 170585, 171526, 172472, 173425, 174383, 175348, 176319,
			177297, 178280, 179271, 180267, 181270, 182280, 183296, 184319,
			185348, 186384, 187428, 188478, 189535, 190599, 191670, 192748,
			193833, 194926, 196026, 197133, 198248, 199370, 200500, 201638,
			202783, 203936, 205097, 206266, 207443, 208628, 209822, 211023,
			212233, 213451, 214677, 215912, 217156, 218408, 219670, 220940,
			222218, 223506, 224804, 226110, 227425, 228750, 230085, 231429,
			232782, 234145, 235519, 236902, 238295, 239698, 241111, 242535,
			243969, 245414, 246869, 248335, 249812, 251299, 252798, 254308,
			255829, 257362, 258906, 260461, 262029, 263608, 265199, 266802,
			268418, 270046, 271686, 273339, 275004, 276683, 278374, 280079,
			281797, 283528, 285273, 287031, 288804, 290590, 292390, 294205,
			296034, 297878, 299736, 301610, 303498, 305402, 307321, 309256,
			311206, 313173, 315155, 317154, 319169, 321201, 323250, 325315,
			327398, 329499, 331617, 333753, 335906, 338079, 340269, 342478,
			344706, 346953, 349220, 351506, 353812, 356138, 358484, 360850,
			363238, 365646, 368075, 370527, 372999, 375494, 378012, 380551,
			383114, 385700, 388309, 390942, 393599, 396280, 398986, 401717,
			404474, 407255, 410063, 412897, 415758, 418645, 421560, 424503,
			427473, 430472, 433500, 436557, 439644, 442760, 445907, 449084,
			452293, 455534, 458806, 462111, 465449, 468820, 472225, 475665,
			479139, 482649, 486194, 489776, 493394, 497051, 500745, 504477,
			508249, 512060, 515911, 519804, 523737, 527713, 531731, 535793,
			539899, 544049, 548245, 552486, 556775, 561111, 565495, 569928,
			574411, 578944, 583529, 588166, 592856, 597600, 602398, 607252,
			612163, 617131, 622158, 627244, 632391, 637599, 642869, 648203,
			653602, 659067, 664598, 670198, 675867, 681606, 687417, 693301,
			699260, 705294, 711405, 717595, 723865, 730216, 736650, 743168,
			749773, 756465, 763247, 770120, 777085, 784146, 791303, 798558,
			805913, 813371, 820934, 828603, 836380, 844269, 852271, 860388,
			868623, 876979, 885458, 894062, 902795, 911659, 920656, 929791,
			939066, 948483, 958047, 967761, 977627, 987650, 997833, 1008180,
			1018694, 1029380, 1040242, 1051284, 1062510, 1073925, 1085533,
			1097339, 1109349, 1121567, 1133998, 1146649, 1159525, 1172631,
			1185973, 1199559, 1213395, 1227486, 1241841, 1256466, 1271370,
			1286559, 1302042, 1317827, 1333924, 1350341, 1367087, 1384172,
			1401607, 1419403, 1437569, 1456118, 1475062, 1494413, 1514184,
			1534389, 1555042, 1576157, 1597751, 1619839, 1642439, 1665568,
			1689244, 1713487, 1738317, 1763756, 1789826, 1816550, 1843954,
			1872063, 1900904, 1930506, 1960900, 1992117, 2024192, 2057159,
			2091056, 2125923, 2161802, 2198738, 2236777, 2275970, 2316370,
			2358033, 2401020, 2445395, 2491226, 2538586, 2587553, 2638210,
			2690647, 2744960, 2801252, 2859634, 2920224, 2983152, 3048556,
			3116587, 3187409, 3261198, 3338147, 3418465, 3502382, 3590150,
			3682043, 3778363, 3879445, 3985656, 4097404, 4215144, 4339379,
			4470676, 4609668, 4757068, 4913684, 5080430, 5258351, 5448642,
			5652680, 5872058, 6108635, 6364587, 6642485, 6945389, 7276972,
			7641686, 8044983, 8493620, 8996081, 9563187, 10208973, 10952013,
			11817468, 12840380, 14071210, 15585669, 17503402, 20026706,
			23530677, 28810664, 37960784, 59457161, Long.MAX_VALUE };

	long[] data = new long[1024];

	public Histogram() {
	}

	public void add(Event e) {
		int index = microsToIndex(e.getMicros());
		data[index]++;
	}

	public void clear() {
		data = new long[1024];
	}

	public int microsToIndex(long searchMicros) {
		if (searchMicros == 0) {
			return 0;
		}
		int start = 0;
		int end = 1023;
		int mid = start + ((end - start) >> 1);
		while (start < end) {
			long midValue = micros[mid];
			if (midValue < searchMicros) {
				start = mid + 1;
			} else {
				end = mid;
			}
			mid = start + ((end - start) >> 1);
		}
		return end;
	}

	public int secondsToIndex(float seconds) {
		long searchMicros = (long) (seconds * 1000000);
		return microsToIndex(searchMicros);
	}

	public float indexToSeconds(int index) {
		return (float) ((1.0 * micros[index]) / 1000000.0);
	}

	public String toString() {
		StringBuilder sb = new StringBuilder();
		for (int i = 0; i < 1024; i++) {
			sb.append(Event.toString(micros[i]) + ":" + data[i] + "\n");
		}
		return sb.toString();
	}

}
